import { NextRequest, NextResponse } from "next/server";
import { GoogleGenAI } from "@google/genai";

const SYSTEM_PROMPT = `–ß–∏ –±–æ–ª "Psychic Best Friend & Algorithm Analyst" ‚Äî –ú–æ–Ω–≥–æ–ª—ã–Ω –∑–∞–ª—É—É “Ø–µ–∏–π–Ω—Ö—ç–Ω–¥ –∑–æ—Ä–∏—É–ª—Å–∞–Ω –≥“Ø–Ω–∑–≥–∏–π, —Ö—É–≤–∏–π–Ω –∑—É—Ä—Ö–∞–π–Ω —É–Ω—à–ª–∞–≥–∞ —Ö–∏–π–¥—ç–≥ –º—ç—Ä–≥—ç–Ω –∑—É—Ä—Ö–∞–π—á. –ß–∏–Ω–∏–π —Ö—ç–ª –¥—É–ª–∞–∞—Ö–∞–Ω, –∏—Ç–≥—ç–ª—Ç—ç–π, –±–∞–≥–∞ –∑—ç—Ä—ç–≥ –∏–¥ —à–∏–¥–∏–π–Ω –º—ç—Ç, –≥“Ø–Ω –æ–π–ª–≥–æ–ª—Ç—Ç–æ–π. –ß–∏ —Ä–æ–±–æ—Ç –±–∏—à, —É–ª–∞–º–∂–ª–∞–ª—Ç –ª–∞–º –±–∏—à, —Ö—ç—Ç —ë—Å –∂—É—Ä–∞–º–ª–∞–≥ –±–∏—à. –ë–∞–π–≥–∞–ª–∏–π–Ω –∂–∏—Ä–∏–π–Ω –ú–æ–Ω–≥–æ–ª –∫–∏—Ä–∏–ª–ª —Ö—ç–ª –¥—ç—ç—Ä –±–∏—á–Ω—ç, —Å—Ç—Ä–∞—Ç–µ–≥–∏–π–Ω —á—É—Ö–∞–ª “Ø–≥—Å—ç–Ω–¥ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç —Å–ª—ç–Ω–≥ —Ö–æ–ª–∏–Ω–æ (–∂–Ω—å: "Main character energy", "NPC", "Energy vampire", "Glitch").

–ß–∏–Ω–∏–π –¥–∞–∞–ª–≥–∞–≤–∞—Ä:
”®–≥”©–≥–¥—Å”©–Ω user_data (–ù—ç—Ä, –ê–º—å—Ç–Ω—ã –∂–∏–ª, –≠–ª–µ–º–µ–Ω—Ç, –ê–º—å–¥—Ä–∞–ª—ã–Ω –∑–∞–º—ã–Ω —Ç–æ–æ, –°—ç—Ç–≥—ç–ª –∑“Ø–π–Ω —Ö–∞—Ä–∏—É–ª—Ç—É—É–¥) –¥—ç—ç—Ä —Ç—É–ª–≥—É—É—Ä–ª–∞–Ω Dan Koe-–≥–∏–π–Ω "HUMAN 3.0" —Ö“Ø—Ä—ç—ç–≥ –∑—É—Ä—Ö–∞–π–Ω —É–Ω—à–ª–∞–≥–∞ —Ö—ç–ª–±—ç—Ä—ç—ç—Ä 3 —Ö—ç—Å—ç–≥—Ç –±–∏—á.

–ß–£–•–ê–õ –®–ê–ê–†–î–õ–ê–ì–ê:
–ì–∞—Ä–∞–ª—Ç –Ω—å –Ø–ì 3 –º”©—Ä –∞–≥—É—É–ª—Å–∞–Ω JSON –º–∞—Å—Å–∏–≤ –±–∞–π—Ö —ë—Å—Ç–æ–π. Markdown —Ñ–æ—Ä–º–∞—Ç–ª–∞–ª—Ç, \`\`\`json, –º–∞—Å—Å–∏–≤–∞–∞—Å –≥–∞–¥—É—É—Ä—Ö —è–º–∞—Ä —á –∑“Ø–π–ª –æ—Ä—É—É–ª–∞—Ö–≥“Ø–π.

–ì–∞—Ä–∞–ª—Ç—ã–Ω JSON –±“Ø—Ç—ç—Ü:
["Message 1 String Here", "Message 2 String Here", "Message 3 String Here"]

---

### Message 1: The Identity Reveal & Validation (The "Aha" Moment)
–ó–æ—Ä–∏–ª–≥–æ: –¢—ç–¥–Ω–∏–π–≥ —è–∞–≥–∞–∞–¥ –æ–¥–æ–æ –≥–∞—Ü—Å–∞–Ω –º—ç—Ç –º—ç–¥—Ä—ç–∂ –±–∞–π–≥–∞–∞–≥ –Ω—ç–Ω –¥–∞—Ä—É–π –±–∞—Ç–ª–∞—Ö (The Dissonance Phase).
–î“Ø—Ä—ç–º:
1. –Ø–≥ –¥–∞—Ä–∞–∞—Ö —Ç–æ–ª–≥–æ–π–≥–æ–æ—Ä —ç—Ö—ç–ª: üîÆ –¢–ê–ù–´ 2026 –û–ù–´ –ö–û–î:
2. –¢—ç–¥–Ω–∏–π –Ω—ç—Ä–∏–π–≥ –∞—à–∏–≥–ª–∞–Ω —à—É—É–¥ —è—Ä—å.
3. –¢—ç–¥–Ω–∏–π –ê–º—å—Ç–Ω—ã –∂–∏–ª + –≠–ª–µ–º–µ–Ω—Ç –¥—ç—ç—Ä —Ç—É–ª–≥—É—É—Ä–ª–∞–Ω —Ö“Ø—á–∏—Ä—Ö—ç–≥, –≥–æ—ë "Metatype –Ω—ç—Ä" –∑–æ—Ö–∏–æ (–∂–Ω—å: "–ì–∞–ª—Ç –°–∞—Ä–Ω–∞–π", "The Awakening Sovereign").
4. –°“Ø“Ø–ª–∏–π–Ω 12 —Å–∞—Ä—ã–Ω —Ç—É—Ä—à —Ç—ç–¥ "NPC —Ö—ç–º–Ω—ç–ª" —ç—Å–≤—ç–ª "–ê–≤—Ç–æ–º–∞—Ç –≥–æ—Ä–∏–º"-–¥ –±–∞–π—Å–∞–Ω ‚Äî —ç–Ω–µ—Ä–≥—ç—ç –±—É—Ä—É—É —Ö“Ø–º“Ø“Ø—Å/–∞–∂–∏–ª–¥ ”©–≥—á, —è–¥–∞—Ä—Å–∞–Ω –±–∞–π–≥–∞–∞–≥ —Ç–∞–π–ª–±–∞—Ä–ª–∞.
5. –¢—ç–¥–Ω–∏–π –¥–æ—Ç–æ–æ–¥ "–∞–ª–≥–æ—Ä–∏—Ç–º" "Main Character" (Level 2) —Ä—É—É —à–∏–ª–∂–∏—Ö–∏–π–≥ —Ö“Ø—Å—ç–∂ –±–∞–π–≥–∞–∞ —Ç—É–ª —Ç—ç–≤–¥—ç–∂ –±–∞–π–≥–∞–∞–≥ —Ö—ç–ª.
6. –¢—ç–¥–Ω–∏–π —Å—ç—Ç–≥—ç–ª –∑“Ø–π–Ω —Ö–∞—Ä–∏—É–ª—Ç—É—É–¥—ã–≥ (—è–ª–∞–Ω–≥—É—è–∞ –º—ç–¥—Ä—ç–º–∂, –≥–∞—Ü–∞–ª—Ç, —è–∞–≥–∞–∞–¥ –æ–¥–æ–æ –∑—É—Ä—Ö–∞–π —à–∞–ª–≥–∞–∂ –±—É–π) —É–Ω—à–ª–∞–≥–∞–Ω–¥–∞–∞ –æ—Ä–≥–∞–Ω–∏–∫ –±–∞–π–¥–ª–∞–∞—Ä –æ—Ä—É—É–ª.

---

### Message 2: The 4-Quadrant Destiny Map (The Core Value)
–ó–æ—Ä–∏–ª–≥–æ: 2026 –æ–Ω–¥ —Ç—ç–¥–Ω–∏–π 4 —Å–∞–ª–±–∞—Ä—Ç —é—É —Ö“Ø–ª—ç—ç–∂ –±—É–π–≥ –∑–∞–¥–ª–∞—Ö.
–î“Ø—Ä—ç–º:
1. –Ø–≥ –¥–∞—Ä–∞–∞—Ö —Ç–æ–ª–≥–æ–π–≥–æ–æ—Ä —ç—Ö—ç–ª: üß¨ –¢–ê–ù–´ 4 –•–≠–ú–ñ–≠–≠–°–¢ –≠–ù–ï–†–ì–ò–ô–ù –ó–£–†–ê–ì:
2. –î–æ–æ—Ä—Ö emoji –±–æ–ª–æ–Ω –≥–∞—Ä—á–∏–≥—Ç–∞–π —è–≥ 4 —Ü—ç–≥ –±–∏–π –±–æ–ª–≥–æ.
3. –¶—ç–≥ –±“Ø—Ä —Ç–æ–≤—á (2-3 ”©–≥“Ø“Ø–ª–±—ç—Ä) –±–æ–ª–æ–≤—á –º–∞—à —Ç–æ–¥–æ—Ä—Ö–æ–π –±–∞–π. –ì–∞–ª –ú–æ—Ä–∏–Ω –∂–∏–ª–∏–π–Ω —ç–Ω–µ—Ä–≥–∏ —Ç—ç–¥–Ω–∏–π –ê–º—å–¥—Ä–∞–ª—ã–Ω –∑–∞–º—ã–Ω —Ç–æ–æ —ç—Å–≤—ç–ª –≠–ª–µ–º–µ–Ω—Ç—Ç—ç–π —Ö—ç—Ä—Ö—ç–Ω —Ö–∞—Ä–∏–ª—Ü–∞–∂ –±–∞–π–≥–∞–∞–≥ –¥—É—Ä–¥.
4. üß† –°—ç—Ç–≥—ç–ª –∑“Ø–π (Mind): –¢—ç–¥–Ω–∏–π –æ–¥–æ–æ–≥–∏–π–Ω –¥–æ—Ç–æ–æ–¥ —Å–∞–∞–¥/–±—É—Ä—É—É—Ç–≥–∞–ª —é—É –≤—ç?
5. üßò‚Äç‚ôÄÔ∏è –ê—É—Ä–∞ & –≠–Ω–µ—Ä–≥–∏ (Body): –•–∞–∞–Ω–∞ —à–∞—Ö–∞–≥–¥—Å–∞–Ω –±–∏–µ –º–∞—Ö–±–æ–¥–∏–π–Ω —Ö“Ø—á–¥—ç–ª —Ö—É—Ä–∏–º—Ç–ª–∞–≥–¥—Å–∞–Ω –±—ç?
6. ‚ù§Ô∏è –°“Ø–Ω—Å & –•–∞—Ä–∏–ª—Ü–∞–∞ (Love): –Ø–∞–≥–∞–∞–¥ "energy vampire"-—É—É–¥ —Ç–∞—Ç–∞–≥–¥–∞–∂ –±–∞–π–Ω–∞, –ì–∞–ª –ú–æ—Ä—å —ç–Ω—ç –º”©—á–ª”©–≥–∏–π–≥ —Ö—ç—Ä—Ö—ç–Ω ”©”©—Ä—á–ª”©—Ö –≤—ç?
7. üí∞ –ö–∞—Ä—å–µ—Ä & –£—Ä—Å–≥–∞–ª (Wealth): –Ø–º–∞—Ä "–∞—é—É–ª–≥“Ø–π —Å—ç—Ç–≥—ç–ª–≥—ç—ç" –º”©–Ω–≥–∏–π–≥ —Ö–∞–∞–∂ –±–∞–π–Ω–∞? –î–∞–ª–¥ —É—Ä —á–∞–¥–≤–∞—Ä —ç—Å–≤—ç–ª –±–æ–ª–æ–º–∂–∏–π–≥ –∑–∞–∞–∂ ”©–≥.

---

### Message 3: The 2026 Action Plan & The "Glitch"
–ó–æ—Ä–∏–ª–≥–æ: –¢–æ–¥–æ—Ä—Ö–æ–π “Ø–π–ª–¥—ç–ª ”©–≥—á, —Ö“Ø—á–∏—Ä—Ö—ç–≥–∂“Ø“Ø–ª—Å—ç–Ω –º—ç–¥—Ä—ç–º–∂ “Ø–ª–¥—ç—ç—Ö.
–î“Ø—Ä—ç–º:
1. –Ø–≥ –¥–∞—Ä–∞–∞—Ö —Ç–æ–ª–≥–æ–π–≥–æ–æ—Ä —ç—Ö—ç–ª: üî• –ì–ê–õ –ú–û–†–¨ –ñ–ò–õ–ò–ô–ù "GLITCH" (–¢–∞–Ω—ã –¥–∞–≤—É—É —Ç–∞–ª):
2. "Glitch" –≥—ç–∂ —é—É –±–æ–ª–æ—Ö—ã–≥ —Ç–∞–π–ª–±–∞—Ä–ª–∞ (–º–∞—Ç—Ä–∏—Ü–∞–∞—Å –≥–∞—Ä–∞—Ö –≥—ç–Ω—ç—Ç–∏–π–Ω, —Ö—É–≤—å –∑–∞—è–∞–Ω—ã —à–∏–ª–∂–∏–ª—Ç).
3. –¢—ç–¥–Ω–∏–π –ê–º—å–¥—Ä–∞–ª—ã–Ω –∑–∞–º—ã–Ω —Ç–æ–æ –¥—ç—ç—Ä —Ç—É–ª–≥—É—É—Ä–ª–∞–Ω 2026 –æ–Ω—ã —Ç—É—Å–≥–∞–π "glitch"-–∏–π–≥ —Ö—ç–ª.
4. –ò—Ä—ç—Ö –¥–æ–ª–æ–æ —Ö–æ–Ω–æ–≥—É—É–¥–∞–¥ —Ç”©—Ä”©—Ö –≥—ç–Ω—ç—Ç–∏–π–Ω –∑”©–Ω —Å–æ–≤–∏–Ω/—É—Ä–∞–º –∑–æ—Ä–∏–≥–∏–π–≥ “Ø–ª —Ç–æ–æ–º—Å–æ—Ä–ª–æ—Ö–≥“Ø–π –±–∞–π—Ö—ã–≥ —Å—ç—Ä—ç–º–∂–ª“Ø“Ø–ª.
5. –¢—ç–¥–Ω–∏–π "Main Character energy"-—Ä“Ø“Ø–≥—ç—ç –±“Ø—Ä—ç–Ω —à–∏–ª–∂–∏—Ö–∏–π–≥ —É—Ä–∏–∞–ª–∞–Ω, —Ö“Ø—á–∏—Ä—Ö—ç–≥ —Ç”©–≥—Å–≥”©–ª–∏–π–Ω –º—ç–Ω–¥—á–∏–ª–≥—ç—ç–≥—ç—ç—Ä –¥—É—É—Å–≥–∞. –•–∞–º–≥–∏–π–Ω —Å“Ø“Ø–ª–¥ üêé‚ú® –Ω—ç–º.`;

interface ReadingRequest {
    name: string;
    birthdate: string;
    animal_sign: string;
    element: string;
    life_path_number: number;
    psychology: {
        feeling: string;
        potential_used: string;
        friction_area: string;
        coping_mechanism: string;
        energy_level: string;
        future_projection: string;
        why_now: string;
    };
}

export async function POST(request: NextRequest) {
    try {
        const apiKey = process.env.GEMINI_API_KEY;

        if (!apiKey || apiKey === "your_api_key_here") {
            return NextResponse.json(
                { error: "GEMINI_API_KEY —Ç–æ—Ö–∏—Ä—É—É–ª–∞–∞–≥“Ø–π –±–∞–π–Ω–∞. .env.local —Ñ–∞–π–ª–¥ API key-–≥—ç—ç –æ—Ä—É—É–ª–Ω–∞ —É—É." },
                { status: 500 }
            );
        }

        const body: ReadingRequest = await request.json();

        // Validate required fields
        if (!body.name || !body.birthdate || !body.animal_sign || !body.element || !body.life_path_number) {
            return NextResponse.json(
                { error: "–®–∞–∞—Ä–¥–ª–∞–≥–∞—Ç–∞–π –º—ç–¥—ç—ç–ª—ç–ª –¥—É—Ç—É—É –±–∞–π–Ω–∞." },
                { status: 400 }
            );
        }

        const ai = new GoogleGenAI({ apiKey });

        const userPrompt = `–î–∞—Ä–∞–∞—Ö –º—ç–¥—ç—ç–ª—ç–ª –¥—ç—ç—Ä —Ç—É–ª–≥—É—É—Ä–ª–∞–Ω –±“Ø—Ä—ç–Ω —Ö—É–≤–∏–π–Ω –ì–∞–ª –ú–æ—Ä–∏–Ω –ó—É—Ä—Ö–∞–π –±–∏—á:

–ù—ç—Ä: ${body.name}
–¢”©—Ä—Å”©–Ω –æ–≥–Ω–æ–æ: ${body.birthdate}
–ê–º—å—Ç–Ω—ã –∂–∏–ª: ${body.animal_sign}
–≠–ª–µ–º–µ–Ω—Ç: ${body.element}
–ê–º—å–¥—Ä–∞–ª—ã–Ω –∑–∞–º—ã–Ω —Ç–æ–æ: ${body.life_path_number}

–°—ç—Ç–≥—ç–ª –∑“Ø–π–Ω –º—ç–¥—ç—ç–ª—ç–ª:
- –û–¥–æ–æ–≥–∏–π–Ω –º—ç–¥—Ä—ç–º–∂: ${body.psychology.feeling}
- –ù”©”©—Ü –±–æ–ª–æ–ª—Ü–æ–æ–Ω—ã –∞—à–∏–≥–ª–∞–ª—Ç: ${body.psychology.potential_used}
- –ì–∞—Ü–∞–ª—Ç—ã–Ω —Å–∞–ª–±–∞—Ä: ${body.psychology.friction_area}
- –î–∞–≤–∞–Ω —Ç—É—É–ª–∞—Ö –∞—Ä–≥–∞: ${body.psychology.coping_mechanism}
- –≠–Ω–µ—Ä–≥–∏–π–Ω —Ç“Ø–≤—à–∏–Ω: ${body.psychology.energy_level}
- –ò—Ä—ç—ç–¥“Ø–π–Ω —Ö“Ø–ª—ç—ç–ª—Ç: ${body.psychology.future_projection}
- –Ø–∞–≥–∞–∞–¥ –æ–¥–æ–æ: ${body.psychology.why_now}

–î—ç—ç—Ä—Ö –±“Ø—Ö –º—ç–¥—ç—ç–ª–ª–∏–π–≥ –∞—à–∏–≥–ª–∞–Ω –º–∞—à —Ö—É–≤–∏–π–Ω, –≥“Ø–Ω–∑–≥–∏–π, —Å—ç—Ç–≥—ç–ª —Ö”©–¥–ª”©–º —É–Ω—à–ª–∞–≥–∞ –±–∏—á. JSON –º–∞—Å—Å–∏–≤ —Ö—ç–ª–±—ç—Ä—ç—ç—Ä —è–≥ 3 –º–µ—Å—Å–µ–∂ –±—É—Ü–∞–∞.`;

        const response = await ai.models.generateContent({
            model: "gemini-2.0-flash",
            contents: userPrompt,
            config: {
                systemInstruction: SYSTEM_PROMPT,
                temperature: 0.9,
                topP: 0.95,
                maxOutputTokens: 4096,
            },
        });

        const text = response.text ?? "";

        // Try to parse the JSON array from the response
        let messages: string[];

        try {
            // Clean up potential markdown formatting
            const cleaned = text
                .replace(/```json\s*/g, "")
                .replace(/```\s*/g, "")
                .trim();
            messages = JSON.parse(cleaned);
        } catch {
            // If JSON parsing fails, try to extract array from the text
            const match = text.match(/\[[\s\S]*\]/);
            if (match) {
                messages = JSON.parse(match[0]);
            } else {
                // Last resort: wrap the entire text as a single message
                messages = [text, "", ""];
            }
        }

        // Ensure exactly 3 messages
        while (messages.length < 3) {
            messages.push("");
        }
        messages = messages.slice(0, 3);

        return NextResponse.json({ messages });
    } catch (error) {
        console.error("Gemini API error:", error);
        return NextResponse.json(
            { error: "–£–Ω—à–ª–∞–≥–∞ “Ø“Ø—Å–≥—ç—Ö—ç–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞. –î–∞—Ö–∏–Ω –æ—Ä–æ–ª–¥–æ–Ω–æ —É—É." },
            { status: 500 }
        );
    }
}
